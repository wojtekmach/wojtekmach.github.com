<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Wojtek Mach]]></title>
  <link href="http://wojtekmach.github.io/atom.xml" rel="self"/>
  <link href="http://wojtekmach.github.io/"/>
  <updated>2016-07-17T23:46:00+00:00</updated>
  <id>http://wojtekmach.github.io/</id>
  <author>
    <name><![CDATA[Wojtek Mach]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[4+ Years of Using Minitest]]></title>
    <link href="http://wojtekmach.github.io/blog/2016/07/17/4-plus-years-of-using-minitest/"/>
    <updated>2016-07-17T19:21:00+00:00</updated>
    <id>http://wojtekmach.github.io/blog/2016/07/17/4-plus-years-of-using-minitest</id>
    <content type="html"><![CDATA[<p>In the <a href="http://wojtekmach.github.io/blog/2015/07/17/testing-shape-of-data">last</a> <a href="http://wojtekmach.github.io/blog/2014/07/17/integration-testing-on-different-levels/">few</a> <a href="http://wojtekmach.github.io/blog/2013/07/17/sharing-examples-in-minitest/">blog</a> <a href="http://wojtekmach.github.io/blog/2012/07/17/liskov-principle-and-minitest/">posts</a> I wrote about my experiments with Minitest in the last few years.
For today&rsquo;s blog post I thought I&rsquo;d write how some of Minitest&rsquo;s design decision affected how I write tests these days and in general how my approach to testing have changed.</p>

<h2>Test cases</h2>

<p>As I wrote in <a href="http://wojtekmach.github.io/blog/2013/07/17/sharing-examples-in-minitest/">Sharing Examples in Minitest</a>, in Minitest we usually write test cases by inheriting from base classes like <code>Minitest::Test</code>, <code>ActionController::TestCase</code> etc.</p>

<p>In my projects I often needed to add some customizations to the tests, e.g. using a Minitest plugin or custom assertions. I used to add these extensions to <code>test/test_helper.rb</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># my_project/test/test_helper.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Minitest</span><span class="o">::</span><span class="no">Test</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">MyCustomAssertions</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Capybara</span><span class="p">:</span><span class="ss">:DSL</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>These days I&rsquo;d usually write custom test cases instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># my_project/test/test_helper.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MyProjectTest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">MyCustomAssertions</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">AcceptanceTest</span> <span class="o">&lt;</span> <span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:IntegrationTest</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Capybara</span><span class="p">:</span><span class="ss">:DSL</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This has a few benefits:</p>

<ul>
<li>no monkey patching.</li>
<li>better code organization. By creating an actual class for each test <em>type</em> it&rsquo;s pretty natural to eventually move it to a separate file (with the name corresponding to the class, somwhere in <code>test/support/</code>) if it grows to be too big.</li>
<li><code>ctags</code> friendliness.</li>
<li>encourages to have even more custom test cases. It&rsquo;s very useful when there&rsquo;s a specific subsystem of the app that deserves it&rsquo;s own test case (e.g. <code>BillingTest</code>) that contains helper methods, custom assertions &amp; perhaps extra docs. Again, <code>ctags</code> friendliness really helps here.</li>
</ul>


<h2>Stubbing &amp; Mocking</h2>

<p>I&rsquo;m speculating here, but I wouldn&rsquo;t be suprised if there would be as many resources praising stubbing (or more broadly, <em>test isolation</em>) as critizing it.</p>

<p>For me, the biggest problems with stubbing are as follows:</p>

<ul>
<li>&ldquo;stubbing at a distance&rdquo; in a <code>setup/before</code> block <em>somewhere</em> in base test case/mixin can lead to very unexpected and hard to track bugs.</li>
<li>&ldquo;stub leaking&rdquo;, when stubbing global objects, can too lead to unexpected and hard to track bugs.</li>
<li>depending on testing/mocking framework it&rsquo;s sometimes very <em>easy</em> to stub multiple things at once, leading to complex and coupled tests that are hard to maintain.</li>
</ul>


<p>Note, none of the issues above is intrisic to a particular testing/mocking library &ndash; it boils down to how it&rsquo;s being used.</p>

<p>Minitest ships with a mocking/stubbing support in the <code>minitest/mock</code> package. Here&rsquo;s an example of stubbing from the docs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_stale_eh</span>
</span><span class='line'>  <span class="n">obj_under_test</span> <span class="o">=</span> <span class="no">Something</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">refute</span> <span class="n">obj_under_test</span><span class="o">.</span><span class="n">stale?</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Time</span><span class="o">.</span><span class="n">stub</span> <span class="ss">:now</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">do</span>   <span class="c1"># stub goes away once the block is done</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">obj_under_test</span><span class="o">.</span><span class="n">stale?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the comment, &ldquo;stub goes away once the block is done&rdquo;.
This is really important and it actually solves, or rather provides a constraint, for all of the problems I listed above.
Since the stubbing happens locally, within the given block, we solve the problem of &ldquo;stubbing at a distance&rdquo; as well as &ldquo;leaking&rdquo;.
In order stub multiple things at once we&rsquo;d need to nest calls to stub which really stands out (as it should) and actually looks pretty terrible. That was the &ldquo;aha&rdquo; moment for me.
This one time, I needed to stub a couple of dependencies and started nesting calls to <code>stub</code> but looking at it, &ldquo;listening to the tests&rdquo;, gave me a pause and I reconsidered my design to have at most one stub in that test and thus having it be more decoupled. In fact, I think I ended up with no stubs at all in that case.</p>

<p>As a matter of fact, I seldom write stubs these days. I tend to prefer writing a &ldquo;fake&rdquo; object instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PaymentGateway</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="vi">@adapter</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@adapter</span> <span class="o">=</span> <span class="n">adapter</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">pay</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@adapter</span><span class="o">.</span><span class="n">pay</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">PaymentGateway</span><span class="o">::</span><span class="no">Payment</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span> <span class="ss">:reference</span><span class="p">,</span> <span class="ss">:amount</span><span class="p">,</span> <span class="ss">:status</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">PaymentGateway</span><span class="o">::</span><span class="no">Stripe</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">pay</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">PaymentGateway</span><span class="o">::</span><span class="no">Fake</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">pay</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">description</span> <span class="o">=~</span> <span class="sr">/failure/</span>
</span><span class='line'>      <span class="no">Payment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="ss">:failure</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="no">Payment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="ss">:success</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s great about this is that I can re-use the fake in many tests as well as in development. I can make the fake more real (but not too real!) by handling important edge case which I can then trivially invoke in, again, both tests &amp; development.</p>

<p>As far as mocking, I seldom do mocking nowadays. Instead of expecting that some object (usually at the boundary of the system) received some message, I&rsquo;d inspect how the (deterministic) return value of my fake object is being used.
In other cases, especially in larger methods when there&rsquo;s some data being calculated and then sent over to an object, I&rsquo;d split the method in two: 1 method that does the calculation (unit tested) and the 2nd method that invokes some other object (usually untested, integration tested instead).</p>

<h2>Tooling &amp; Practices</h2>

<p>I&rsquo;m constantly impressed how Minitest community is pushing for better tooling and practices. Perhaps tools/ideas things haven&rsquo;t originated in Minitest, but it&rsquo;s where I first encountered them:</p>

<ul>
<li>randomize tests by default</li>
<li><a href="http://www.zenspider.com/ruby/2012/01/assert_nothing_tested.html">assert_nothing_tested</a></li>
<li><a href="https://github.com/seattlerb/minitest-bisect">minitest-bisect</a></li>
<li><a href="https://github.com/seattlerb/minitest/pull/626"><code>assert_equal</code> should not allow <code>nil</code> for &ldquo;expected&rdquo;</a></li>
<li>&ldquo;fail test when there&rsquo;re no assertions&rdquo; (can&rsquo;t find a link)</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing Shape of Data]]></title>
    <link href="http://wojtekmach.github.io/blog/2015/07/17/testing-shape-of-data/"/>
    <updated>2015-07-17T09:00:00+00:00</updated>
    <id>http://wojtekmach.github.io/blog/2015/07/17/testing-shape-of-data</id>
    <content type="html"><![CDATA[<p><a href="http://wojtekmach.github.io/blog/2014/07/17/integration-testing-on-different-levels/">Last time</a> I wrote about integration testing on different levels and in this post I want to explore topic that&rsquo;s somewhat related to integration testing.</p>

<p>When testing code that integrates with DBs and JSON APIs I often find myself only caring about (and wanting to test) a subset of data. To give a concrete example, let&rsquo;s say we&rsquo;re integration testing a simple Rails controller with <code>/items</code> endpoint.</p>

<p>The simplest possible test for that could be just:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_create</span>
</span><span class='line'>  <span class="no">Item</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Item 1&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Item</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Item 2&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s2">&quot;/items&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span>
</span><span class='line'>    <span class="p">{</span><span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Item 1&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Item 2&quot;</span><span class="p">},</span>
</span><span class='line'>  <span class="o">]</span><span class="p">,</span> <span class="no">JSON</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s a problem with this test and it&rsquo;s the hardcoded ids (this is even more painful with things like <code>created_at</code>). This can be pretty easily solved by introducing local variables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_create</span>
</span><span class='line'>  <span class="n">item1</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Item 1&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">item2</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Item 2&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s2">&quot;/items&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span>
</span><span class='line'>    <span class="p">{</span><span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="n">item1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Item 1&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="n">item2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Item 2&quot;</span><span class="p">},</span>
</span><span class='line'>  <span class="o">]</span><span class="p">,</span> <span class="no">JSON</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, I think this introduced some complexity into the test code and decreased readability a bit. Also, I don&rsquo;t really care what are the ids that have been auto-generated by my DB. My <strong>intent</strong> is to test the <code>name</code> attribute was correctly saved, and the <code>id</code> attribute is just an accidental detail.</p>

<p>Another way of addressing this problem is introducing even more complexity into the test code, by extracting only the fields I care about:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_create</span>
</span><span class='line'>  <span class="n">item1</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Item 1&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">item2</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Item 2&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s2">&quot;/items&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span>
</span><span class='line'>    <span class="s2">&quot;Item 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Item 2&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="o">]</span><span class="p">,</span> <span class="no">JSON</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, I think this is really hard to read. Moreover, when this test grows I&rsquo;d be concerned about a possibility of introducing a bug in my <em>test code</em>.</p>

<p>As mentioned above, my intent is to test the <code>name</code> attribute and I don&rsquo;t really care what&rsquo;s the <code>id</code> attribute &ndash; it can be <strong>any</strong> integer, as far as I&rsquo;m concerned in this test. This is the test I&rsquo;d like to write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_create</span>
</span><span class='line'>  <span class="n">item1</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Item 1&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">item2</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Item 2&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s2">&quot;/items&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="o">[</span>
</span><span class='line'>    <span class="p">{</span><span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="n">any_integer</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Item 1&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="n">any_integer</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Item 2&quot;</span><span class="p">},</span>
</span><span class='line'>  <span class="o">]</span><span class="p">,</span> <span class="no">JSON</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and let me show you how this can be achieved.</p>

<h2>Building <code>any_integer</code></h2>

<p>Let&rsquo;s break down the test above into the simplest possible code we could discuss. It boils down to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">assert_equal</span> <span class="o">[</span><span class="n">any_integer</span><span class="p">,</span> <span class="n">any_integer</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Minitest&rsquo;s <code>assert_equal</code> uses Ruby&rsquo;s equality operator <code>==</code> to do the comparison. In this case, we&rsquo;re equaling two <code>Array</code>s and <a href="http://ruby-doc.org/core-2.2.0/Array.html#method-i-3D-3D">per documentation</a> &ldquo;Two arrays are equal if they contain the same number of elements and if each element is equal to (according to Object#==)&rdquo;</p>

<p>So, all we need to do is to implement the <code>==</code> method on the <code>any_integer</code> object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AnyInteger</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">==</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class='line'>    <span class="n">other</span><span class="o">.</span><span class="n">is_a?</span> <span class="nb">Integer</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">def</span> <span class="nf">any_integer</span>
</span><span class='line'>  <span class="no">AnyInteger</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="n">any_integer</span><span class="p">,</span> <span class="n">any_integer</span><span class="o">]</span> <span class="o">==</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>    <span class="c1"># =&gt; true</span>
</span><span class='line'><span class="o">[</span><span class="n">any_integer</span><span class="p">,</span> <span class="n">any_integer</span><span class="o">]</span> <span class="o">==</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:bad</span><span class="o">]</span> <span class="c1"># =&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>any_integer</code> and many other methods (as well as ways to <em>compose</em> them) is available on GitHub: <a href="https://github.com/wojtekmach/anything">https://github.com/wojtekmach/anything</a>, <a href="https://github.com/wojtekmach/anything/blob/master/test/anything_test.rb">https://github.com/wojtekmach/anything/blob/master/test/anything_test.rb</a></p>

<h2>Conclusion</h2>

<p>In this post I described a different approach to testing data structures where in some cases the exact value isn&rsquo;t as important as long as some property of that value is being checked. One could say that testing for type (and not for actual value) is kind of weak and languages with static types are solving this &ldquo;by design&rdquo; and I tend to agree. However, what I&rsquo;m trying to show here is testing for &ldquo;shape&rdquo; of data (which is very useful in JSON APIs) and avoiding adding complexity in test code by extracting only a subset of attributes that matter. I was inspired by ideas from property-based testing to write this blog post, but I&rsquo;m not sure people would say these two techniques are related. If anything, one could say that instead of bringing the best of both worlds (exact values from example-based testing and checking properties against random data from propert-based testing) I&rsquo;m showing the worst of both worlds :&ndash;) Let me know what you think in the comments!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Integration testing on different levels]]></title>
    <link href="http://wojtekmach.github.io/blog/2014/07/17/integration-testing-on-different-levels/"/>
    <updated>2014-07-17T23:17:00+00:00</updated>
    <id>http://wojtekmach.github.io/blog/2014/07/17/integration-testing-on-different-levels</id>
    <content type="html"><![CDATA[<p><a href="http://wojtekmach.github.io/blog/2013/07/17/sharing-examples-in-minitest/">Last time</a> I wrote about sharing examples in Minitest. This time I want to show an idea I had for a long time about reusing the same test to verify system&rsquo;s behavior on different levels.</p>

<p>Let&rsquo;s say we&rsquo;re building a simple signup application. We may end up with a test like this:</p>

<p>(Check out full code here: <a href="https://github.com/wojtekmach/signups">https://github.com/wojtekmach/signups</a>)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SignupWebTest</span> <span class="o">&lt;</span> <span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:IntegrationTest</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_success</span>
</span><span class='line'>    <span class="n">visit</span> <span class="s2">&quot;/&quot;</span>
</span><span class='line'>    <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">&quot;example@gmail.com&quot;</span>
</span><span class='line'>    <span class="n">click_button</span> <span class="s2">&quot;Sign up&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span> <span class="n">page</span><span class="o">.</span><span class="n">has_content?</span> <span class="s2">&quot;Thanks!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_failure</span>
</span><span class='line'>    <span class="n">visit</span> <span class="s2">&quot;/&quot;</span>
</span><span class='line'>    <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">&quot;invalid&quot;</span>
</span><span class='line'>    <span class="n">click_button</span> <span class="s2">&quot;Sign up&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span> <span class="n">signup</span><span class="o">.</span><span class="n">has_content?</span> <span class="s2">&quot;Email&quot;</span> <span class="s2">&quot;is invalid&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s say we also want to have an API. Often times we are testing the same two scenarios as above, usually with the same test data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SignupAPITest</span> <span class="o">&lt;</span> <span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:IntegrationTest</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_success</span>
</span><span class='line'>    <span class="n">post</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span> <span class="ss">signup</span><span class="p">:</span> <span class="p">{</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;example@gmail.com&#39;</span><span class="p">}</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">last_response</span><span class="o">.</span><span class="n">succes?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_failure</span>
</span><span class='line'>    <span class="n">post</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span> <span class="ss">signup</span><span class="p">:</span> <span class="p">{</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">}</span>
</span><span class='line'>    <span class="n">refute</span> <span class="n">last_response</span><span class="o">.</span><span class="n">succes?</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="no">Hash</span><span class="o">[</span><span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;is invalid&#39;</span><span class="o">]]</span><span class="p">,</span> <span class="no">JSON</span><span class="p">(</span><span class="n">last_response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;errors&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we also have the lower level test that&rsquo;s using the application logic directly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SignupTest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_success</span>
</span><span class='line'>    <span class="n">signup</span> <span class="o">=</span> <span class="no">Signup</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;example@gmail.com&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">signup</span><span class="o">.</span><span class="n">submit</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">signup</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>    <span class="c1"># assert email was sent etc.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_failure</span>
</span><span class='line'>    <span class="n">signup</span> <span class="o">=</span> <span class="no">Signup</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">refute</span> <span class="n">signup</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="no">Hash</span><span class="o">[</span><span class="ss">email</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;is invalid&#39;</span><span class="o">]]</span><span class="p">,</span> <span class="n">signup</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">messages</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can extract the common part from all tests into helper methods like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SignupWebTest</span> <span class="o">&lt;</span> <span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:IntegrationTest</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_success</span>
</span><span class='line'>    <span class="n">signup</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;example@gmail.com&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">page</span><span class="o">.</span><span class="n">has_content?</span> <span class="s2">&quot;Thanks!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_failure</span>
</span><span class='line'>    <span class="n">signup</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">signup</span><span class="o">.</span><span class="n">has_content?</span> <span class="s2">&quot;Email&quot;</span> <span class="s2">&quot;is invalid&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="n">visit</span> <span class="s2">&quot;/&quot;</span>
</span><span class='line'>    <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
</span><span class='line'>    <span class="n">click_button</span> <span class="s2">&quot;Sign up&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SignupAPITest</span> <span class="o">&lt;</span> <span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:IntegrationTest</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_success</span>
</span><span class='line'>    <span class="n">signup</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;example@gmail.com&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">last_response</span><span class="o">.</span><span class="n">succes?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_failure</span>
</span><span class='line'>    <span class="n">signup</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="no">Hash</span><span class="o">[</span><span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;is invalid&#39;</span><span class="o">]]</span><span class="p">,</span> <span class="no">JSON</span><span class="p">(</span><span class="n">last_response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;errors&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="n">post</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span> <span class="ss">signup</span><span class="p">:</span> <span class="n">attributes</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As I am writing this, without thinking about it, I was just gonna work on cleaning up the 3rd test but, which is kind of the point of this post, there isn&rsquo;t anything to clean up there. There&rsquo;s no duplication that&rsquo;s worth extracting out or some test/production API quirks worth hiding. Since we fully control the application code we can design it however we want.</p>

<p>This brings us back to the title of this post about reusing the same test on different levels. What I want to do is to design an interface that will behave like the <code>Signup</code> class, but under the hood will either call the application logic directly or use Web UI or API. The test must be written in such a way it&rsquo;s easy to inject dependencies.
Here&rsquo;s one approach; I write it as a module that will be later included into concrete test cases.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">SignupTests</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_success</span>
</span><span class='line'>    <span class="n">signup</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;example@gmail.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">submit</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">signup</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_failure</span>
</span><span class='line'>    <span class="n">signup</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">signup</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">submit</span>
</span><span class='line'>    <span class="n">assert</span> <span class="o">!</span><span class="n">signup</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="no">Hash</span><span class="o">[</span><span class="ss">email</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;is invalid&#39;</span><span class="o">]]</span><span class="p">,</span> <span class="n">signup</span><span class="o">.</span><span class="n">error_messages</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s an <code>@app</code>? It&rsquo;s an <em>object</em> that knows how to construct <em>object</em> that can play a role of a <code>Signup</code>. Object that can play role of <code>@app</code> need only to implement <code>#signup</code> <em>message</em>. For <code>Signup</code> <em>role</em> they need <code>#submit</code>, <code>#valid?</code> and <code>#error_messages</code>. Here are possible implementations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">WebClient</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Signup</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Signup</span>
</span><span class='line'>    <span class="kp">include</span> <span class="ss">Capybara</span><span class="p">:</span><span class="ss">:DSL</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">submit</span>
</span><span class='line'>      <span class="n">visit</span> <span class="s1">&#39;/&#39;</span>
</span><span class='line'>      <span class="n">fill_in</span> <span class="s1">&#39;Email&#39;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="vi">@email</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">valid?</span>
</span><span class='line'>      <span class="n">page</span><span class="o">.</span><span class="n">has_content?</span> <span class="s2">&quot;Thanks!&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">APIClient</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">base_uri</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@base_uri</span> <span class="o">=</span> <span class="n">base_uri</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Signup</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Signup</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@client</span><span class="p">,</span> <span class="vi">@attributes</span> <span class="o">=</span> <span class="n">client</span><span class="p">,</span> <span class="n">attributes</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">submit</span>
</span><span class='line'>      <span class="no">RestClient</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="vi">@client</span><span class="o">.</span><span class="n">base_uri</span> <span class="o">+</span> <span class="s2">&quot;/signup&quot;</span><span class="p">,</span> <span class="ss">signup</span><span class="p">:</span> <span class="vi">@attributes</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># ...</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">App</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">signup</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Signup</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can write the remaining concrete test cases:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SignupAppTest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">SignupTests</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SignupAPITest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">SignupTests</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="no">WebMock</span><span class="o">.</span><span class="n">stub_request</span><span class="p">(</span><span class="ss">:any</span><span class="p">,</span> <span class="sr">/signup.test/</span><span class="p">)</span><span class="o">.</span><span class="n">to_rack</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="no">APIClient</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;http://signup.test&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SignupWebTest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">SignupTests</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="no">Capybara</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span>
</span><span class='line'>    <span class="vi">@app</span> <span class="o">=</span> <span class="no">WebClient</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s a few nice benefits about this design.</p>

<p>For one thing this setup is highly configurable. We can easily switch certain levels on and off. What&rsquo;s more, we can take this configuration further and for the UI &amp; API tests point them to live servers (e.g. staging.example.com) instead of local servers on development machine. This has added benefit that we can find more errors this way, like for example asset pipeline &amp; general deployment issues, DNS etc. Granted, this works extremely well for a simple application as such that&rsquo;s basically stateless but it should still be doable for more complex cases.</p>

<p>This test design also forced us to write mostly production (albeit not used by the production app) code and just a little bit of simple test code. A nice side effect of this is I think you&rsquo;d generally keep this code more organized if it&rsquo;s not a part of the test suite. More importantly though as a way of testing the app we built client libraries to access API (See <a href="http://robots.thoughtbot.com/how-to-test-sinatra-based-web-services">http://robots.thoughtbot.com/how-to-test-sinatra-based-web-services</a>) and the Web UI. If you&rsquo;re lucky enough to have a dedicated QA team they may appreciate that they can drive the app using quite convenient interface yet still be able to access raw features of capybara etc.</p>

<p>Finally, there&rsquo;s one more thing maybe worth mentioning. If we have 2 instances of the app running on <code>app1.example.com</code> and <code>app2.example.com</code> it&rsquo;s entirely possible to configure <code>app1</code>&rsquo;s controllers to use <code>APIClient</code> (instead of simply <code>App</code>) pointed to <code>app2.example.com</code> without a single change in the application code. Again, probably not that useful but I think it&rsquo;s pretty cool :&ndash;)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sharing examples in Minitest]]></title>
    <link href="http://wojtekmach.github.io/blog/2013/07/17/sharing-examples-in-minitest/"/>
    <updated>2013-07-17T22:26:00+00:00</updated>
    <id>http://wojtekmach.github.io/blog/2013/07/17/sharing-examples-in-minitest</id>
    <content type="html"><![CDATA[<p><a href="http://wojtekmach.github.io/blog/2012/07/17/liskov-principle-and-minitest/">Last time</a> I wrote about enforcing Liskov principle via tests. It was pretty simple to do in Minitest using just class inheritance. Sometimes, however, we can&rsquo;t inherit test methods because the framework forces us to inherit from a test case class like:</p>

<ul>
<li><code>ActiveSupport::TestCase</code></li>
<li><code>ActionDispatch::IntegrationTest</code></li>
</ul>


<p>etc. In these cases we need to find some other way to share behavior and with Minitest&rsquo;s design the answer is pretty simple &ndash; modules.</p>

<h2>Example</h2>

<p>Let&rsquo;s write a simple data store library inspired by <a href="https://github.com/minad/moneta">Moneta</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DataStore</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@adapter</span> <span class="o">=</span> <span class="n">adapter</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@adapter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@adapter</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s write an adapter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DataStore</span><span class="o">::</span><span class="no">InMemoryAdapter</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@hash</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@hash</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s write a test for this. Knowing we will later reuse test methods, we start with a module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">DataStore::AdapterTest</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_get_not_found</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="kp">nil</span><span class="p">,</span> <span class="vi">@adapter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="ss">:invalid</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_set</span>
</span><span class='line'>    <span class="vi">@adapter</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="ss">:foo</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">42</span><span class="p">,</span> <span class="vi">@adapter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the actual <code>DataStore::InMemoryAdapter</code> test (note, I&rsquo;m using <code>Minitest::Test</code> which comes from minitest 5):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">DataStore</span><span class="o">::</span><span class="no">InMemoryAdapterTest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">DataStore</span><span class="p">:</span><span class="ss">:AdapterTest</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@adapter</span> <span class="o">=</span> <span class="ss">DataStore</span><span class="p">:</span><span class="ss">:InMemoryAdapter</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this we see that two examples have been &ldquo;inherited&rdquo; from the shared module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~% ruby shared.rb
</span><span class='line'>Run options: --seed 18221
</span><span class='line'>
</span><span class='line'><span class="c"># Running:</span>
</span><span class='line'>
</span><span class='line'>..
</span><span class='line'>
</span><span class='line'>Finished in 0.001126s, 1776.1989 runs/s, 1776.1989 assertions/s.
</span><span class='line'>
</span><span class='line'>2 runs, 2 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre></td></tr></table></div></figure>


<p>With this foundation it&rsquo;s pretty easy to add new adapters and we don&rsquo;t really have to write new tests. Including shared module in the test is enough to have confidence that an adapter is conforming to an interface.</p>

<p>Let&rsquo;s say we package the data store as a gem. We can ship the <code>AdapterTest</code> as an integral part of the gem distribution and let the users write their own application specific adapters. Just as Rails ships with <code>ActionDsipatch::IntegrationTest</code>.</p>

<h2>minitest/spec</h2>

<p>It&rsquo;s actually pretty easy to use shared modules with minitest/spec. It&rsquo;s simple because minitest/spec is really just a DSL on top of minitest/test (minitest/unit). A <code>describe</code> block creates a new <code>Minitest::Test</code> class, an <code>it</code> block defines a new <code>test_</code> method. With this in mind we can start with our custom DSL like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">DataStore::AdapterSpec</span>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;returns nil for an invalid key&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@adapter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="ss">:invalid</span><span class="p">)</span><span class="o">.</span><span class="n">must_equal</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;can set a value&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@adapter</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="ss">:foo</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@adapter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span><span class="o">.</span><span class="n">must_equal</span> <span class="mi">42</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the spec:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="ss">DataStore</span><span class="p">:</span><span class="ss">:InMemoryAdapter</span> <span class="k">do</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">DataStore</span><span class="p">:</span><span class="ss">:AdapterSpec</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@adapter</span> <span class="o">=</span> <span class="ss">DataStore</span><span class="p">:</span><span class="ss">:InMemoryAdapter</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this will result in error like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;module:AdapterSpec&gt;: undefined method <span class="s1">&#39;it&#39;</span> <span class="k">for </span>DataStore::AdapterSpec:Module <span class="o">(</span>NoMethodError<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s fix this; we basically have to implement <code>Module#it</code> for it to work:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Module</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">it</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_method</span> <span class="s2">&quot;test_</span><span class="si">#{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Tests should be passing now.</p>

<p>I mentioned before that minitest/spec is just a DSL. In fact, there&rsquo;s literally a <a href="https://github.com/seattlerb/minitest/blob/363ff3fe7c0144f6d02d04dabad9ceee5d252fa7/lib/minitest/spec.rb#L96">Minitest::Spec::DSL module</a> that <code>Minitest::Spec</code> is including. The DSL module is so good in fact that it can be included both in classes and in other modules:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Module</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Spec</span><span class="o">::</span><span class="no">DSL</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and it just works! We now can do stuff like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">SomeTest</span>
</span><span class='line'>  <span class="n">before</span> <span class="p">{</span> <span class="s2">&quot;...&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">after</span> <span class="p">{</span> <span class="s2">&quot;...&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;...&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;returns this&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;returns that&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>etc.</p>

<p>The way <code>Minitest::Spec::DSL</code> is implemented is actually pretty simple. It doesn&rsquo;t do anything special; it just defines a bunch of methods like <code>setup</code>, <code>teardown</code>, <code>foo</code>, <code>test_returns_this</code> etc. It means that after the &ldquo;DSL&rdquo; phase we end up with just a ruby module that we can include (or not), and nothing is evaluated until the module is included somewhere.</p>

<h2>Conclusion</h2>

<p>Minitest&rsquo;s simple design allows us to extend it with standard tools we use in day to day ruby programming. We can use the same exact constructs like classes, modules, inheritance &amp; mixins for both the production &amp; test code. As a consequence of this design writing minitest extensions is imho pretty easy too!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Liskov Principle & MiniTest]]></title>
    <link href="http://wojtekmach.github.io/blog/2012/07/17/liskov-principle-and-minitest/"/>
    <updated>2012-07-17T22:26:00+00:00</updated>
    <id>http://wojtekmach.github.io/blog/2012/07/17/liskov-principle-and-minitest</id>
    <content type="html"><![CDATA[<h2>What is Liskov Principle?</h2>

<p>In layman’s terms Liskov Substitution Principle says that if class <code>Foo</code> inherits from class <code>Bar</code>, then you should be able to use (<em>substitute</em>) derived class in every place that the base class is used. For a better definition and further references check out <a href="http://www.objectmentor.com/resources/articles/lsp.pdf">The Liskov Substitution Principle</a> by Uncle Bob.</p>

<h2>Testing LSP with MiniTest</h2>

<p>MiniTest has a really simple design. A test case is a class and an example is a method of that class. After requiring minitest/autorun every subclass of <code>MiniTest::Unit::TestCase</code> is instantiated and test methods are executed one by one.</p>

<p>One very nice result of this design, which is kind of obvious when you think about it, is that you can not only inherit helper methods (eg. you subclass <code>ActionController::TestCase</code> to have get, post etc) but you may as well inherit whole examples! This is a perfect way to test LSP because, again, you should be able to substitute base class with a derived class.</p>

<h2>Example</h2>

<p>Let’s re-implement Ruby’s built-in <code>Set</code> class. I’ll write a test first:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SetTest</span> <span class="o">&lt;</span> <span class="ss">MiniTest</span><span class="p">:</span><span class="ss">:Unit</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@set</span> <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_size</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">0</span><span class="p">,</span> <span class="vi">@set</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">42</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="vi">@set</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_include?</span>
</span><span class='line'>    <span class="n">refute</span> <span class="vi">@set</span><span class="o">.</span><span class="n">include?</span> <span class="mi">42</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">42</span>
</span><span class='line'>    <span class="n">assert</span> <span class="vi">@set</span><span class="o">.</span><span class="n">include?</span> <span class="mi">42</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_add</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">13</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">13</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="vi">@set</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_to_a</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">1</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">4</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">2</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ary</span> <span class="o">=</span> <span class="vi">@set</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ary</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">ary</span><span class="o">.</span><span class="n">include?</span> <span class="mi">1</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">ary</span><span class="o">.</span><span class="n">include?</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">ary</span><span class="o">.</span><span class="n">include?</span> <span class="mi">4</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note I didn’t write the exact result of <code>Set#to_a</code> because a cannonical set is unordered. A Ruby 1.9 built-in Set is actually ordered, it simply preserves the order of insertion.</p>

<p>A basic implementation is very easy using Hash like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Set</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Enumerable</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@hash</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">size</span>
</span><span class='line'>    <span class="vi">@hash</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@hash</span><span class="o">[</span><span class="n">obj</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">include?</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@hash</span><span class="o">.</span><span class="n">include?</span> <span class="n">obj</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@hash</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let’s run it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~% ruby set.rb
</span><span class='line'>Run options: --seed 59316
</span><span class='line'>
</span><span class='line'><span class="c"># Running tests:</span>
</span><span class='line'>
</span><span class='line'>....
</span><span class='line'>
</span><span class='line'>Finished tests in 0.000589s, 6791.1715 tests/s, 15280.1358 assertions/s.
</span><span class='line'>
</span><span class='line'>4 tests, 9 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre></td></tr></table></div></figure>


<p>Now, let’s write a <code>SortedSet</code> that will keep values sorted. Again let’s write a test and run it first:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SortedSetTest</span> <span class="o">&lt;</span> <span class="no">SetTest</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~% ruby set.rb
</span><span class='line'>Run options: --seed 54235
</span><span class='line'>
</span><span class='line'><span class="c"># Running tests:</span>
</span><span class='line'>
</span><span class='line'>........
</span><span class='line'>
</span><span class='line'>Finished tests in 0.000944s, 8474.5763 tests/s, 19067.7966 assertions/s.
</span><span class='line'>
</span><span class='line'>8 tests, 18 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre></td></tr></table></div></figure>


<p>We now have exactly twice assertions because all test methods have been inherited. Let’s now build a simple <code>SortedSet</code> class and adjust the test, so that we actually use the derived class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SortedSetTest</span> <span class="o">&lt;</span> <span class="no">SetTest</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@set</span> <span class="o">=</span> <span class="no">SortedSet</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SortedSet</span> <span class="o">&lt;</span> <span class="no">Set</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@hash</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sure enough all tests passes and we’re now certain that a <code>Set</code> object can be substituted with a <code>SortedSet</code> object.</p>

<p>Let’s also test the unique behaviour of the SortedSet. We won’t just define <code>test_to_a</code> method, because we would overwrite assertions from the base test. We’ll pick a different name instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SortedSetTest</span> <span class="o">&lt;</span> <span class="no">SetTest</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@set</span> <span class="o">=</span> <span class="no">SortedSet</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_to_a_sorted</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">1</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">4</span>
</span><span class='line'>    <span class="vi">@set</span><span class="o">.</span><span class="n">add</span> <span class="mi">2</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span><span class="p">,</span> <span class="vi">@set</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we could stop it right here, but you propably noticed some duplication between <code>test_to_a</code> and <code>test_to_a_sorted</code>. Again, because we’re using just classes and methods, we can actually write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SortedSetTest</span> <span class="o">&lt;</span> <span class="no">SetTest</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">setup</span>
</span><span class='line'>    <span class="vi">@set</span> <span class="o">=</span> <span class="no">SortedSet</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">test_to_a</span>
</span><span class='line'>    <span class="k">super</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="o">]</span><span class="p">,</span> <span class="vi">@set</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I’m not sure if it’s that useful and you should use it, but you must agree it’s pretty neat!</p>
]]></content>
  </entry>
  
</feed>
